REPORT zobject_instance_lifetime.

CLASS lcl_test DEFINITION CREATE PUBLIC.

  PUBLIC SECTION.
    DATA i TYPE i.
    DATA s TYPE string.
    DATA s2 TYPE string.

    METHODS get_string_ref RETURNING VALUE(result) TYPE REF TO string.
    METHODS set_string IMPORTING i_s TYPE string.
  PROTECTED SECTION.
  PRIVATE SECTION.
ENDCLASS.

CLASS lcl_test IMPLEMENTATION.

  METHOD get_string_ref.
    result = REF #( s2 ).
  ENDMETHOD.

  METHOD set_string.
    s = i_s.
  ENDMETHOD.

ENDCLASS.

CLASS lcl_main DEFINITION CREATE PUBLIC.
  PUBLIC SECTION.
    METHODS run.
ENDCLASS.

CLASS lcl_main IMPLEMENTATION.

  METHOD run.

    DATA(o) = NEW lcl_test( ).
    o->s = `Foo`.
    CLEAR o.
    cl_abap_memory_utilities=>do_garbage_collection( ).

    o = NEW lcl_test( ).
    o->s = `Foo`.
    o->s2 = `1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890` &&
            `1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890` &&
            `1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890` &&
            `1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890` &&
            `1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890`.
    CLEAR o.
    cl_abap_memory_utilities=>do_garbage_collection( ).

    o = NEW lcl_test( ).
    o->s = `Foo`.
    o->s2 = `1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890` &&
            `1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890` &&
            `1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890` &&
            `1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890` &&
            `1234567890123456789012345678901234567890123456789012345678901234567890123456789012345678901234567890`.
    DATA(sref) = o->get_string_ref( ).
    CLEAR o.
    cl_abap_memory_utilities=>do_garbage_collection( ).

    clear sref.

    cl_abap_memory_utilities=>do_garbage_collection( ).

  ENDMETHOD.

ENDCLASS.

START-OF-SELECTION.
  NEW lcl_main( )->run( ).
